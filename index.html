<!DOCTYPE html>
<html lang="en">
	<head>
		<!-- Global Site Tag (gtag.js) - Google Analytics -->
		<script async src="https://www.googletagmanager.com/gtag/js?id=UA-106586544-1"></script>
		<script>
		  window.dataLayer = window.dataLayer || [];
		  function gtag(){dataLayer.push(arguments)};
		  gtag('js', new Date());

		  gtag('config', 'UA-106586544-1');
		</script>

		<title>Art Source Map</title>

		<!-- Required meta tags -->
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
		<meta name="description" content="Map of specialist video game outsourcing companies" />
		<meta name="keywords" content="leaflet, outsource, map" />
		<meta name="author" content="Kalvin Lyle" />

		<!-- favicon -->
		<link type="text/css" rel="shortcut icon" type="image/x-icon" href="assets/brand/favicon.ico">

		<!-- Leaflet CSS -->
		<link rel="stylesheet" href="https://unpkg.com/leaflet@1.2.0/dist/leaflet.css"
			integrity="sha512-M2wvCLH6DSRazYeZRIm1JnYyh22purTM+FDB5CsyxtQJYeKq83arPe5wgbNmcFXGqiSH2XR8dT/fJISVA1r/zQ=="
			crossorigin=""/>
<!--
		<link rel="stylesheet" href="leaflet.markercluster/MarkerCluster.css" />
		<link rel="stylesheet" href="leaflet.markercluster/MarkerCluster.Default.css" />
-->
		<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.0.6/dist/MarkerCluster.css" />
		<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.0.6/dist/MarkerCluster.Default.css" />
		<link rel="stylesheet" href="leaflet.groupedlayercontrol/leaflet.groupedlayercontrol.min.css" />
		<link rel="stylesheet" href="leaflet-search/dist/leaflet-search.src.css" />

		<!-- Bootstrap CSS -->
		<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta/css/bootstrap.min.css" 
			integrity="sha384-/Y6pD6FV/Vv2HJnA6t+vslU6fwYXjCFtcEpHbNJ0lyAFsXTsjBbfaDjzALeQsN6M"
			crossorigin="anonymous">
		<link href="open-iconic/font/css/open-iconic-bootstrap.css" rel="stylesheet">

		<!-- Custom CSS -->
		<style>
			body {
				overflow:hidden;
			}
			#map {
				position: absolute;
				height: calc(100% - 56px);
				width: 100%;
			}
			#findbox {
				border: 0px;
				padding: 0px;
				margin: 0px;
				width: 290px;
				height: 36px;
			}
			.leaflet-control-search .search-input {
				margin: 0px;
				padding-left: 10px;
				height: 36px;
			}
			.search-tooltip {
				margin-top: 20px;
				width: 300px;
			}
			.leaflet-control-search .search-button {
				display: none;
			}
			.leaflet-control-search .search-cancel {
				margin-top: 6px;
				margin-right: -60px;
			}
		</style>

	</head>

	<script src="https://unpkg.com/feather-icons/dist/feather.min.js"></script>
	<body>

	<!-- Nav -->
	<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
		<button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarTogglerDemo03" aria-controls="navbarTogglerDemo03" aria-expanded="false" aria-label="Toggle navigation">
			<span class="navbar-toggler-icon"></span>
		</button>
		<a class="navbar-brand" href="#">Art Source Hub</a>

		<div class="collapse navbar-collapse" id="navbarTogglerDemo03">
			<div class="mr-auto mt-2 mt-lg-0">
				<button type="button" class="btn btn-sm btn-outline-light" data-toggle="modal" data-target="#aboutModal">About</button>
			</div>
			<div id="findbox"></div>
<!--
			<form class="form-inline my-2 my-lg-0">
				<input class="form-control mr-sm-2" type="text" placeholder="Search" aria-label="Search">
				<button class="btn btn-success my-2 my-sm-0" type="submit">Search</button>
			</form>
-->
		</div>
	</nav>

	<!-- Modal:About -->
	<div class="modal fade" id="aboutModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLongTitle" aria-hidden="true">
		<div class="modal-dialog" role="document">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" id="exampleModalLongTitle">About</h5>
					<button type="button" class="close" data-dismiss="modal" aria-label="Close">
						<span aria-hidden="true">&times;</span>
					</button>
				</div>
				<div class="modal-body">
					<p>ArtsourceHub.com is a <strong>video game industry resource</strong>, focused on providing an <strong>easily searchable</strong><strong> database</strong> that allows developers and publishers to <strong>identify external service companies</strong> that they might be interested in working with.</p>
					<h4>Data Curation</h4>
					<ul>
					<li><u>Open Data</u>: All data is open for all to add, edit and update (for now)</li>
					<li><u>Downloadable</u>: Most information can be downloaded in csv format</li>
					<!--
					<li><u>Service Providers</u>: Specifically, service companies with more than 3 employees. Individual freelancers are trimmed from the supplier list simply because that data tends to change more often and is harder to maintain.</li>
					<li><u>Game Credits</u>: Service lists are pulled from curated game credits rather than company websites. Clients care what you have done on what projects. That information allows them to select supplier that have a higher understanding of the products they are making.</li>
					<li><u>Hand Validated</u>: Every vendor in the data base has been verified by hand to ensure they are active at the time they are added to the database.</li>
					-->
					</ul>
					<h4>Credits</h4>
					<p>This map was made possible through the extensive use of a number of open source projects:</p>
					<ul>
					<li><u>Leaflet</u>: The map is built with <a href="http://leafletjs.com/">Leafletjs</a> and the <a href="https://github.com/Leaflet/Leaflet.markercluster">Leaflet Marker Cluster</a> add-on.</li>
					<li><u>Leaflet Users Map</u>: The <a href="https://github.com/bmcbride/leaflet-users-map">Leaflet Users Map</a> by Biran McBride was the starting point for the code.</li>
					<li><u>ArcGIS</u>: The map layer is provide by <a href="http://www.arcgis.com">ArcGIS</a>.</li>
					<li><u>Open Street Map</u>: The geoLocation is provided by <a href="http://www.openstreetmap.org">OpenStreetMap.org</a>.</li>
					<li><u>Bootstrap</u>: The site was built with <a href="http://getbootstrap.com/">Bootstrap</a>.</li>
					</ul>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
				</div>
			</div>
		</div>
	</div>

	<!-- Modal:deleteCompany -->
	<div class="modal fade" id="deleteCompanyModal" tabindex="-1" role="dialog" aria-labelledby="deleteCompanyModal" aria-hidden="true">
		<div class="modal-dialog" role="document">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title">Remove the Studio from the map?</h5>
					<button type="button" class="close" data-dismiss="modal" aria-label="Close">
						<span aria-hidden="true">&times;</span>
					</button>
				</div>
				<div class="modal-body">
					<p>Removing a Company from the Map is serios business.</p>
					<p>Are you sure you want to Delete the Company from the Map?</p>
				</div>
				<div class="modal-footer">
					<button type="button" onclick="$('#deleteCompanyModal').modal('hide'); deleteCompany(); return false;" class="btn btn-danger" data-dismiss="modal">Delete!</button>
					<button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
				</div>
			</div>
		</div>
	</div>

	<!-- Modal:addCompany -->
	<div class="modal fade" id="addCompanyModal" tabindex="-1" role="dialog" aria-labelledby="addCompanyModal" aria-hidden="true">
		<div class="modal-dialog" role="document">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title">Add a Studio to the map!</h5>
					<button type="button" class="close" data-dismiss="modal" aria-label="Close">
						<span aria-hidden="true">&times;</span>
					</button>
				</div>
				<div class="modal-body">
					<p>Click on the Go! button below to get started.</p>
					<p>Navigate to your desired location and click on the map to drop a marker. Fill in the required information and Submit.</p>
				</div>
				<div class="modal-footer">
			        <button type="button" class="btn btn-primary" onclick="$('#addCompanyModal').modal('hide'); initRegistration(); return false;">Go!</button>
					<button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
				</div>
			</div>
		</div>
	</div>

	<!-- Modal:insertSuccessModal -->
	<div class="modal fade" id="insertSuccessModal" tabindex="-1" role="dialog">
		<div class="modal-dialog" role="document">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title">Success</h5>
					<button type="button" class="close" data-dismiss="modal" aria-label="Close">
						<span aria-hidden="true">&times;</span>
					</button>
				</div>
				<div class="modal-body">
					<p>Thanks for your contribution to the Map!</p>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
				</div>
			</div>
		</div>
	</div>

	<!-- Map -->
	<div class="container-fluid mh-100" id="map"></div>

	<!-- jQuery Scripts -->
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
	<!-- <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js"
		integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN"
		crossorigin="anonymous"></script> -->

	<!-- Bootstrap Scripts -->
	<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.11.0/umd/popper.min.js" 
		integrity="sha384-b/U6ypiBEHpOf/4+1nzFpr53nxSS+GLCkfwBdFNTxtclqqenISfwAzpKaMNFNmj4"
		crossorigin="anonymous"></script>
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta/js/bootstrap.min.js"	
		integrity="sha384-h0AbiXch4ZDo7tp9hKZ4TsHbi047NrKGLO3SEJAg45jXxnGIfYzk4Si90RDIqNm1"
		crossorigin="anonymous"></script>

	<!-- Leaflet Scripts -->
	<script src="https://unpkg.com/leaflet@1.2.0/dist/leaflet.js"
		integrity="sha512-lInM/apFSqyy1o6s89K4iQUKg6ppXEgsVxT35HbzUupEVRh2Eu9Wdl4tHj7dZO0s1uvplcYGmt3498TtHq+log=="
		crossorigin=""></script>
	<script src="https://unpkg.com/leaflet.markercluster@1.1.0/dist/leaflet.markercluster-src.js"></script>
	<script src="https://unpkg.com/leaflet.markercluster.layersupport@1.0.5/dist/leaflet.markercluster.layersupport-src.js"></script>
	<script src="leaflet.groupedlayercontrol/leaflet.groupedlayercontrol.min.js"></script>
	<script src="leaflet-search/dist/leaflet-search.min.js"></script>

	<!-- Map Script -->
	<script type="application/javascript">

/*************************/
//		Map Setup
/*************************/

		firstLoad = true;
		
		var world = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/{z}/{y}/{x}', {
				attribution: 'Tiles &copy; Esri &mdash; Source: Esri, DeLorme, NAVTEQ, USGS, Intermap, iPC, NRCAN, Esri Japan, METI, Esri China (Hong Kong), Esri (Thailand), TomTom, 2012',
				minZoom: 3,
				maxZoom: 17,
			}),
			latlng = L.latLng(50, 10);

		//Create Map
		var map = L.map('map', {layers: [world], worldCopyJump: true, center: latlng});

//TODO ITEM:
//Grab list of Layer Groups from the database and add them automatically
//Makes for a more reuseable codebase.

		//Create and Add Layer Groups to Map
		var markers = L.markerClusterGroup.layerSupport({
				disableClusteringAtZoom: 20,
/*				iconCreateFunction: function (cluster) {
					var markers = cluster.getAllChildMarkers();
					var n = 0;
					for (var i = 0; i < markers.length; i++) {
						n += markers[i].number;
					}
					return L.divIcon({ html: n, className: 'mycluster', iconSize: L.point(40, 40) });
				},
*/				spiderfyDistanceMultiplier: 1,
				maxClusterRadius: 25,
				spiderfyOnMaxZoom: true,
				showCoverageOnHover: false,
				zoomToBoundsOnClick: true
			}),
			supplier = L.layerGroup(),
			developer = L.layerGroup(),
			organization = L.layerGroup(),
			publisher = L.layerGroup(),
			vr = L.layerGroup(),
			mobile = L.layerGroup(),
			online = L.layerGroup(),
			selfpub = L.layerGroup(),
			audio = L.layerGroup(),
			anim = L.layerGroup(),
			brand = L.layerGroup(),
			loc = L.layerGroup(),
			qa = L.layerGroup(),
			vfx = L.layerGroup(),
			ui = L.layerGroup(),
			design = L.layerGroup(),
			concept = L.layerGroup(),
			art = L.layerGroup(),
			codev = L.layerGroup(),
			control = L.control.layers(null, null, { collapsed: false }),
			i, a, title, marker;
		markers.addTo(map);

		//Create a group to isloate markers whiel editing them
		markerEdit = new L.LayerGroup();
		markerEdit.addTo(map);


		//Add Groups to the Marker Cluster
		markers.checkIn([supplier, publisher, organization, developer, selfpub, mobile, vr, online, audio, anim, brand, loc, qa, vfx, ui, design, concept, art, codev]);

		//Add groups to the Map
		supplier.addTo(map);
		publisher.addTo(map);
		organization.addTo(map);
		developer.addTo(map);
		selfpub.addTo(map);
		mobile.addTo(map);
		vr.addTo(map);
		online.addTo(map);
		audio.addTo(map);
		anim.addTo(map);
		brand.addTo(map);
		loc.addTo(map);
		qa.addTo(map);
		vfx.addTo(map);
		ui.addTo(map);
		design.addTo(map);
		concept.addTo(map);
		art.addTo(map);
		codev.addTo(map);

		//define Layer Groups
		var groupedOverlays = {
		  "Suppliers": {
			"Supplier": supplier,
			"Audio/Music": audio,
			"Animation/Video": anim,
			"Brand/Marketing": brand,
			"Locatization": loc,
			"Testing": qa,
			"VFX/Lighting": vfx,
			"UI/UX": ui,
			"Design": design,
			"Concept": concept,
			"Env & Character": art,
			"Co-Development": codev
		  },
		  "Developers": {
			"Developer": developer,
			"Mobile Devs": mobile,
			"Virtual Reality": vr,
			"Online": online,
			"Self Publishing": selfpub
		  },
		  "Publisher": {
			"Organization": organization,
			"Publisher": publisher
		  }
		};

		//Add the Add Company Button to the UI
		var addCompany = new L.control({ position: 'topleft' });
		addCompany.onAdd = function (map) {
			var div = L.DomUtil.create('div', 'leaflet-control-layers leaflet-control');
			div.innerHTML = '<a class="leaflet-control" style="margin: 0; width: 30px; height: 30px; background-color: rgba(40,187,69,1.0);" data-toggle="modal" href="#addCompanyModal" title="Add company"><span class="oi oi-map-marker oi-size-lg" style="padding-left: 8px; padding-top:5px; font-size: 18px; color: #ffffff;" title="Add Company" aria-hidden="true"></span></a>';
			return div;
		};
		map.addControl(addCompany);

		//Add the Submit Issue button
		var submitIssue = new L.control({ position: 'bottomright' });
		submitIssue.onAdd = function (map) {
			var div = L.DomUtil.create('div', 'leaflet-control-layers leaflet-control');
			div.innerHTML = '<a class="leaflet-control" style="margin: 0; width: 40px; height: 40px; background-color: rgba(240,87,69,1.0);" href="https://github.com/kalvinlyle/artsourcehub.com/issues/new" target="_blank" title="Github"><span class="oi oi-bug oi-size-lg" style="padding-left: 6px; padding-top:0px; font-size: 30px; color: #ffffff;" title="Add Company" aria-hidden="true"></span></a>';
			return div;
		};
		map.addControl(submitIssue);

		//Add search to the map
		var controlSearch = new L.Control.Search({
			container:'findbox',		
			layer: markers,
			initial: false,
			collapsed: false,
			zoom: 10,
			marker: false
		});

		map.addControl( controlSearch );

		//Add the Layers Selector to the UI
		var groupedLayerOptions = {
		  // Make the "Landmarks" group exclusive (use radio inputs)
		  //exclusiveGroups: ["Landmarks"],
		  // Show a checkbox next to non-exclusive group labels for toggling all
		  groupCheckboxes: true
		};

		var mapLayers = L.control.groupedLayers(null, groupedOverlays, groupedLayerOptions);
		map.addControl(mapLayers);

		//Get Markers the first time the page is loaded and set the initial view
		$(document).ready(function() {
			$.ajaxSetup({cache:false});
			getMarkers();
			if (window.location.protocol === 'https:')
			{
				map.locate({setView: true, maxZoom: 20});
				function onLocationError(e) {
					alert(e.message);
				}
				map.on('locationerror', onLocationError);
			} else {
				map.setView(latlng, 4);
				//var bounds = markers.getBounds();
				//map.fitBounds(bounds, {maxZoom: 15});
			}
		});

/*************************/
//		Custom Markers
/*************************/

//TODO ITEM:
//switch to L.Divicon so the CSS can be swapped to grey out markers rather than having to reload all the markers after an edit

		var greenIcon = L.icon({
			iconUrl: 'assets/images/marker-icon-green.png',
			shadowUrl: 'assets/images/marker-shadow.png',

			iconSize:     [25, 41], // size of the icon
		    shadowSize:   [41, 41], // size of the shadow
		    iconAnchor:   [12, 41], // point of the icon which will correspond to marker's location
		    shadowAnchor: [12, 41],  // the same for the shadow
		    popupAnchor:  [0, -41] // point from which the popup should open relative to the iconAnchor
		});

		var greyIcon = L.icon({
			iconUrl: 'assets/images/marker-icon-grey.png',
			shadowUrl: 'assets/images/marker-shadow.png',

			iconSize:     [25, 41], // size of the icon
		    shadowSize:   [41, 41], // size of the shadow
		    iconAnchor:   [12, 41], // point of the icon which will correspond to marker's location
		    shadowAnchor: [12, 41],  // the same for the shadow
		    popupAnchor:  [0, -41] // point from which the popup should open relative to the iconAnchor
		});

		var redIcon = L.icon({
			iconUrl: 'assets/images/marker-icon-red.png',
			shadowUrl: 'assets/images/marker-shadow.png',

			iconSize:     [25, 41], // size of the icon
		    shadowSize:   [41, 41], // size of the shadow
		    iconAnchor:   [12, 41], // point of the icon which will correspond to marker's location
		    shadowAnchor: [12, 41],  // the same for the shadow
		    popupAnchor:  [0, -41] // point from which the popup should open relative to the iconAnchor
		});

		var yellowIcon = L.icon({
			iconUrl: 'assets/images/marker-icon-yellow.png',
			shadowUrl: 'assets/images/marker-shadow.png',

			iconSize:     [25, 41], // size of the icon
		    shadowSize:   [41, 41], // size of the shadow
		    iconAnchor:   [12, 41], // point of the icon which will correspond to marker's location
		    shadowAnchor: [12, 41],  // the same for the shadow
		    popupAnchor:  [0, -41] // point from which the popup should open relative to the iconAnchor
		});

/*************************/
//		Functions
/*************************/

		//Extend the base Marker class to include require studio information
		var stMarker = L.Marker.extend({
			options: { 
				stId: 0,
				stName: '',
				stUrl: 'http://',
				stType: 1,
				stCat: 1,
				stLoc: '',
				stLat: 0,
				stLng: 0
			}
		});

//TODO ITEM:
//Make addPopup, setIcon, setGroup etc functions.

		//Get Markers and add them to the map
		function getMarkers() {

			$.getJSON("company_get.php", function (data) {
				for (var i = 0; i < data.length; i++) {
					var companyId = data[i].id;
					var companyName = data[i].name;
					var companyType = data[i].type;
					var companyTypeName = data[i].type_name;
					var companyCategory = data[i].category;
					var companyCategoryName = data[i].category_name;
					var companyWebsite = data[i].website;
					var companyAddress = data[i].address.replace(/\&lt;\/br&gt;/ig, '');
					var companyLat = data[i].lat;
					var companyLng = data[i].lng;
					var location = new L.LatLng(companyLat, companyLng);
					var markerGroup;

					var markerVariables = {
						title: data[i].name,
						stId: data[i].id,
						stName: data[i].name,
						stUrl: data[i].website,
						stType: data[i].type,
						stCat: data[i].category,
						stAdd: data[i].address.replace(/\&lt;\/br&gt;/ig, ''),
						stLat: data[i].lat,
						stLng: data[i].lng
					};

					//set the icon by category
					var markerIcon;
					switch(companyCategoryName) {
						case "Supplier":
							markerIcon = {icon: redIcon};
							break;
						case "Developer":
							markerIcon = {icon: greenIcon};
							break;
						case "Publisher":
							markerIcon = {};			//use the default icon
							break;
					}
					var markerOptions = Object.assign({}, markerVariables, markerIcon);
					var marker = new stMarker(location, markerOptions);

					//set the markerGroup by type
					switch(companyTypeName) {
						case "Developer":
							markerGroup = developer;
							break;
						case "Publisher":
							markerGroup = publisher;
							break;
						case "Supplier":
							markerGroup = supplier;
							break;
						case "Supplier":
							markerGroup = supplier;
							break;
						case "Audio/Music":
							markerGroup = audio;
							break;
						case "Animation/Video":
							markerGroup = anim;
							break;
						case "Brand/Marketing":
							markerGroup = brand;
							break;
						case "Locatization":
							markerGroup = loc;
							break;
						case "Testing":
							markerGroup = qa;
							break;
						case "VFX/Lighting":
							markerGroup = vfx;
							break;
						case "UI/UX":
							markerGroup = ui;
							break;
						case "Design":
							markerGroup = design;
							break;
						case "Concept":
							markerGroup = concept;
							break;
						case "Env & Character":
							markerGroup = art;
							break;
						case "Co-Development":
							markerGroup = codev;
							break;
						case "Developer":
							markerGroup = developer;
							break;
						case "Mobile Devs":
							markerGroup = mobile;
							break;
						case "Virtual Reality":
							markerGroup = vr;
							break;
						case "Online":
							markerGroup = online;
							break;
						case "Self Publishing":
							markerGroup = selfpub;
							break;
						case "Organization":
							markerGroup = organization;
							break;
						case "Publisher":
							markerGroup = publisher;
							break;
					};
					marker.addTo(markerGroup);

					
					markers.addLayer(marker);

					//create & bind popup contents
					var title = "<div style='font-size: 18px; color: #0078A8;'>";
					if (marker.options.stUrl) {
						title = title +"<a href='"+ marker.options.stUrl +"' target='_blank'>"+ marker.options.stName + "</a>";
					} else {
						title = title + marker.stName;
					}
					title = title +"</div>";
					var address = "<div style='font-size: 14px;'>"+ marker.options.stAdd +"</div>";				
					var editButton = '</br><form id="inputform" enctype="multipart/form-data">'+
						'<input style="display: none;" type="text" id="markerId" name="markerId" value="'+ markers.getLayerId(marker) +'"/>'+
						'<input style="display: none;" type="text" id="companyId" name="companyId" value="'+ marker.options.stId +'"/>'+
						'<input style="display: none;" type="text" id="companyName" name="companyName" value="'+ marker.options.stName +'"/>'+
						'<input style="display: none;" type="text" id="companyWebsite" name="companyWebsite" value="'+ marker.options.stUrl +'"/>'+
						'<input style="display: none;" type="text" id="companyAddress" name="companyAddress" value="'+ marker.options.stAdd +'"/>'+
						'<input style="display: none;" type="text" id="companyType" name="companyType" value="'+ marker.options.stTyp +'"/>'+
						'<input style="display: none;" type="text" id="lat" name="lat" value="'+ marker.options.stLat +'" />'+
						'<input style="display: none;" type="text" id="lng" name="lng" value="'+ marker.options.stLng +'" />'+
						'<div class="row-fluid">'+
						'<div class="span" style="text-align:center;"><button type="button" class="btn btn-primary" onclick="editCompany('+ markers.getLayerId(marker) +')">Edit</button></div>'+
						'</div>'+
						'</form>';
					marker.bindPopup("<div style='text-align: center; margin-left: auto; margin-right: auto;'>"+ title + address + editButton +"</div>", {maxWidth: '400'});
//					marker.addTo(markerGroup).on('click', onClick); //sends an onclick event for that marker
				}
			}, function() {
				if (firstLoad == true) {
					map.locate({setView: true, maxZoom: 4});
					//map.fitBounds(markers.getBounds());
					map.zoomSnap;
					firstLoad = false;
				};
			});
		}

//TODO ITEM:
//It must be possible to combine initRegistration and initEdit functions into one

		function addcss(css){
			var head = document.getElementsByTagName('head')[0];
			var s = document.createElement('link');
			s.setAttribute('type', 'text/css');
			s.setAttribute('rel', 'stylesheet');
			s.setAttribute('href', css);
			head.appendChild(s);
		}

		//Start Add Mode
		function initRegistration() {
			$('link[rel=stylesheet][href*="MarkerCluster.Default.css"]').remove();
			addcss("leaflet-markercluster/MarkerCluster.Disabled.css");
			//marker.on('dragend', setNewMarkerPosition);
			map.addEventListener('click', addMarker);
			markers.options.zoomToBoundsOnClick = false;			//disable clusterclick
			map.removeControl(addCompany);
			map.removeControl(mapLayers);
			markers.eachLayer(function(m){
				m.options.interactive = false;
				m.setIcon(greyIcon);
			});
			$('#map').css('cursor', 'crosshair');
			map.options.closePopupOnClick = false;
			return false;
		}

		//Start Edit Mode
		function initEdit(marker) {
			$('link[rel=stylesheet][href*="MarkerCluster.Default.css"]').remove();
			addcss("leaflet-markercluster/MarkerCluster.Disabled.css");
			marker.on('dragend', setNewMarkerPosition);
			map.addEventListener('click', setNewMarkerPosition);		//Clicking on the map will set newMarker positions
			markers.options.zoomToBoundsOnClick = false;			//disable clusterclick
			map.removeControl(addCompany);
			map.removeControl(mapLayers);
			markers.eachLayer(function(m){			//make all other markers non-interactve
				m.options.interactive= false;
				m.setIcon(greyIcon);
			});
			$('#map').css('cursor', 'crosshair');			//Swap the map cursor to a cross hair
			map.options.closePopupOnClick = false;
			return false;
		}

//TODO ITEM:
//It must be possible to combine cancelRegistration and cancelEdit functions into one

		function cancelRegistration() {
			$('link[rel=stylesheet][href~="MarkerCluster.Disabled.css"]').remove();
			addcss("leaflet-markercluster/MarkerCluster.Default.css");
			$('#map').css('cursor', '');
			map.removeEventListener('click', addMarker);
			map.removeEventListener('click', setNewMarkerPosition);
			markers.options.zoomToBoundsOnClick = true;			//enable clusterclick
			map.addControl(addCompany);
			map.addControl(mapLayers);
			markers.clearLayers();
			markerEdit.clearLayers();
			getMarkers();
		}

		//Start Edit Mode
		function cancelEdit() {
			$('link[rel=stylesheet][href~="MarkerCluster.Disabled.css"]').remove();
			addcss("leaflet-markercluster/MarkerCluster.Default.css");
			$('#map').css('cursor', '');
			map.options.closePopupOnClick = true;
			map.removeEventListener('click', setNewMarkerPosition);
			markers.options.zoomToBoundsOnClick = true;			//enable clusterclick
			map.addControl(addCompany);
			map.addControl(mapLayers);
			markers.clearLayers();
			markerEdit.clearLayers();
			getMarkers();
		}

		function setNewMarkerStats() {
			markerEdit.eachLayer(function(m){
				m.options.stUrl = document.getElementById("website").value;
				m.options.stName = document.getElementById("name").value;
				m.options.stAdd = document.getElementById("location").value;
				m.options.stType = document.getElementById("type").value;
				m.options.stLat = document.getElementById("lat").value;
				m.options.stLng = document.getElementById("lng").value;
			});
		}

		// Reopen popups and update LatLng data
		function setNewMarkerPosition(e) {
			if (typeof e.target._latlng !== 'undefined') { var  latlng = e.target._latlng; } else { var latlng = e.latlng; }
			markerEdit.eachLayer(function(m){
				m.setLatLng(latlng);
				m.openPopup();
				document.getElementById("website").value = m.options.stUrl;
				document.getElementById("name").value = m.options.stName;
				document.getElementById("location").value = m.options.stAdd;
				document.getElementById("type").value = m.options.stType;
				document.getElementById("lat").value = latlng.lat.toFixed(6);
				document.getElementById("lng").value = latlng.lng.toFixed(6);
			});
			updateAddress(latlng.lat.toFixed(6), latlng.lng.toFixed(6));
			map.panTo(latlng);
		}

		function addressLookup() {
			var markerId = $("#markerId").val();
			if (markerAddressText !== "") {
				var addressURL =  'http://nominatim.openstreetmap.org/search?q='+ markerAddressText +'&format=json&zoom=1&addressdetails=1&accept-language=en';
				$.ajax({
					type: "GET",
					url: addressURL,
					contentType: "application/json; charset=utf-8",
					success: function(data) {
						if (data.length > 0) {
							var latlng = new L.LatLng(data[0].lat,data[0].lon);
							map.panTo(latlng);
							marker = markerEdit.getLayer(markerId);
							marker.setLatLng(latlng)
							marker.openPopup();
							document.getElementById("website").value = marker.options.stUrl;
							document.getElementById("name").value = marker.options.stname;
							document.getElementById("location").value = marker.options.stAdd;
							document.getElementById("type").value = marker.options.stType;
							document.getElementById("lat").value = data[0].lat;
							document.getElementById("lng").value = data[0].lon;
							updateAddress(data[0].lat, data[0].lon);
						} else {
							alert('Invalid location');
						}
					},
					dataType: 'json'
				});
			} else {
				alert('Invalid location');
			}
		}

		function updateAddress(lat, lon) {
			var addressURL =  'http://nominatim.openstreetmap.org/reverse?lat='+lat+'&lon='+lon+'&format=json&zoom=18&addressdetails=1&accept-language=en';
			$.getJSON(addressURL, function (data) {
				var address = [];
				var street = [];
				var city = [];
				var state = [];
				var country = [];
				if (data.address.road ) { street.push(data.address.road); }
				if (data.address.house_number ) { street.push(data.address.house_number); }
				if (street.length > 0) { address.push(street.join(', ') + "\n"); }
				if (data.address.city ) { city.push(data.address.city); }
				if (data.address.hamlet) { city.push(data.address.hamlet); }
				if (data.address.village) { city.push(data.address.village); }
				if (city.length > 0) { address.push(city.join(', ') + "\n"); }
				if (data.address.postcode) { state.push(data.address.postcode); }
				if (data.address.country) { state.push(data.address.country); }
				if (state.length > 0) { address.push(state.join(', ')); }
				if ( address.length > 0 ) {
					document.getElementById("location").value = address.join(', ');
				}else{
					document.getElementById("location").value = data.display_name;
				}
			});
		}

//TODO ITEM:
//Change setNewMarkerPosition to create a marker if one does not exist... then addMarker and setNewMarkerPosition can be the same function
//addMarker then becomes createMarker()

		function addMarker(e) {
			var markerLocation = new L.LatLng(e.latlng.lat, e.latlng.lng);
			marker = new L.Marker(markerLocation, {draggable:true});
			marker.on('dragend', setNewMarkerPosition);
			markerEdit.clearLayers();
			markerEdit.addLayer(marker);
			updateAddress(e.latlng.lat.toFixed(6), e.latlng.lng.toFixed(6));
			markerType = 1;
			var addForm =  '<form>'+
					'<div class="form-group" style="margin-bottom:8px">'+
						'<h5>Add Company</h5>'+
					'</div>'+
					'<div class="form-group" style="margin-bottom:8px">'+
						'<div class="input-group">'+
							'<label class="input-group-addon" id="basic-addon3">Name</label>'+
							'<input type="text" class="form-control" placeholder="Required" id="name" onchange="setNewMarkerStats()" />'+
						'</div>'+
					'</div>'+
					'<div class="form-group" style="margin-bottom:8px">'+
						'<div class="input-group">'+
							'<label class="input-group-addon" id="basic-addon3">URL</label>'+
							'<input type="text" class="form-control" placeholder="http:// (Required)" id="website" onchange="setNewMarkerStats()" />'+
						'</div>'+
					'</div>'+
					'<form id="#addressLookup">'+
						'<div class="form-group" style="margin-bottom:8px">'+
							'<div class="input-group">'+
								'<label class="input-group-addon" id="basic-addon3">Addr.</label>'+
								'<input type="text" class="form-control" placeholder="Enter Address" id="location" onchange="setNewMarkerStats()"/>'+
								'<input style="display: none;" type="text" id="markerId" value="'+ markerEdit.getLayerId(marker) +'" aria-hidden="true"/>'+
								'<span class="input-group-btn" >'+
									'<button class="btn btn-secondary" onclick="addressLookup(); return false;" style="padding: 5px 10px 5px 10px; "><span class="oi oi-map-marker oi-size-lg" style="padding-top: 2px; font-size: 20px; color: #ffffff;" aria-hidden="true"></span></button>'+
								'</span>'+
							'</div>'+
						'</div>'+
					'</form>'+
					'<div class="form-group" style="margin-bottom:8px">'+
						'<div class="input-group">'+
							'<label class="input-group-addon" id="basic-addon3">Type</label>'+
							'<select class="form-control" id="type" onchange="setNewMarkerStats()">'+
								'<optgroup label="Supplier">'+
									'<option value=1>Supplier</option>'+
									'<option value=9>Audio & Music</option>'+
									'<option value=10>Animation & Video</option>'+
									'<option value=11>Brand & Marketing</option>'+
									'<option value=12>Localization & Writing</option>'+
									'<option value=13>QA & Testing</option>'+
									'<option value=14>VFX & Lighting</option>'+
									'<option value=15>UI & Player Experience</option>'+
									'<option value=16>Game & Level Design</option>'+
									'<option value=17>Concept & Illustration</option>'+
									'<option value=18>Environment & Character</option>'+
									'<option value=19>Full Service & Co-Developmeny</option>'+
								'<optgroup label="Developer">'+
									'<option value=2>Developer</option>'+
									'<option value=5>Virtual Reality</option>'+
									'<option value=6>Mobile</option>'+
									'<option value=7>Online</option>'+
									'<option value=8>Developer and Publisher</option>'+
								'<optgroup label="Publisher">'+
									'<option value=4>Publisher</option>'+
									'<option value=3>Organization</option>'+
							'</select>'+
						'</div>'+
					'</div>'+
					'<input style="display: none;" type="text" id="location" name="location"/>'+
					'<input style="display: none;" type="text" id="lat" value="'+e.latlng.lat.toFixed(6)+'" aria-hidden="true"/>'+
					'<input style="display: none;" type="text" id="lng" value="'+e.latlng.lng.toFixed(6)+'" aria-hidden="true"/>'+
					'<div class="modal-footer" style="padding: 0px; border: 0px;">'+
						'<button type="button" class="btn" onclick="cancelRegistration()">Cancel</button>'+
						'<button type="button" class="btn btn-primary" onclick="insertCompany()">Submit</button>'+
					'</div>'+
				'</form>';
			marker.bindPopup(addForm, {autoClose: false, closeOnClick: false, closeButton: false, autoPanPadding: 5, keepInView: false, minWidth: 300, maxWidth: 800}).openPopup();
			marker.setIcon(yellowIcon);
			map.panTo(e.latlng);

			//switch the onclick event from making a new marker to simply moving the existign one
			map.removeEventListener('click', addMarker);
			map.addEventListener('click', setNewMarkerPosition);
		}

		function clone(obj) {
			if (null == obj || "object" != typeof obj) return obj;
			var copy = obj.constructor();
			for (var attr in obj) {
				if (obj.hasOwnProperty(attr)) copy[attr] = obj[attr];
			}
			return copy;
		}

		//Edit Company
		function editCompany(markerId) {

			var om = markers.getLayer(markerId);

			var location = new L.LatLng(om.options.stLat, om.options.stLng);
			var markerOptions = {
				location,
				icon: yellowIcon,
				draggable: true,
				title: om.options.title,
				stId: om.options.stId,
				stName: om.options.stName,
				stUrl: om.options.stUrl,
				stType: om.options.stType,
				stCat: om.options.stCat,
				stAdd: om.options.stAdd,
				stLat: om.options.stLat,
				stLng: om.options.stLng
			};
			
			var marker = new stMarker(location, markerOptions);		//Make a new Marker
			markers.removeLayer(om);								//Remove the old marker
			markerEdit.addLayer(marker);							//Add new marker to non-clustering map group

			var editForm =  '<form id="regexpForm">'+
					'<div class="form-group" style="margin-bottom:8px">'+
						'<h5>Edit Company</h5>'+
					'</div>'+
					'<div class="form-group" style="margin-bottom:8px">'+
						'<input style="display: none;" type="text" id="companyId" value="'+ marker.options.stId +'" aria-hidden="true"/>'+
						'<div class="input-group">'+
							'<label class="input-group-addon" id="basic-addon3">Name</label>'+
							'<input type="text" class="form-control" placeholder="Required" id="name" value="'+ marker.options.stName +'" onchange="setNewMarkerStats()"/>'+
							'<span class="input-group-btn">'+
							'<button type="button" class="btn btn-secondary dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">'+
								'<span class="oi oi-magnifying-glass oi-size-lg" style="padding-top:2px; font-size: 20px; color: #ffffff;" aria-hidden="true"></span>'+
							'</button>'+

								'<div class="dropdown-menu">'+
									'<a class="dropdown-item" href="https://www.google.com/search?q='+ marker.options.stName +'" target="_blank" style="padding: 5px 10px 5px 10px; "><span class="oi oi-magnifying-glass oi-size-lg" style="padding-top:2px; font-size: 20px; color: #6c757d;" aria-hidden="true"></span> Search Google</a>'+
									'<a class="dropdown-item" href="https://www.google.com/maps/search/'+ marker.options.stName +'" target="_blank" style="padding: 5px 10px 5px 10px; "><span class="oi oi-map-marker oi-size-lg" style="padding-top: 2px; font-size: 20px; color: #6c757d;" aria-hidden="true"></span> Search Google Maps</a>'+
								'</div>'+
							'</span>'+
						'</div>'+
					'</div>'+
					'<div class="form-group" style="margin-bottom:8px">'+
						'<div class="input-group">'+
							'<label class="input-group-addon" id="basic-addon3">URL</label>'+
							'<input type="text" class="form-control" placeholder="http://" id="website" value="'+ marker.options.stUrl +'" onchange="setNewMarkerStats()"/>'+
							'<span class="input-group-btn">'+
								'<a class="btn btn-secondary" href="'+ marker.options.stUrl +'" target="_blank" style="padding: 5px 10px 5px 10px; "><span class="oi oi-external-link oi-size-lg" style="padding-top:5px; font-size: 18px; color: #ffffff;" aria-hidden="true"></span></a>'+
							'</span>'+
						'</div>'+
					'</div>'+
					'<form>'+
						'<div class="form-group" style="margin-bottom:8px">'+
							'<div class="input-group">'+
								'<label class="input-group-addon" id="basic-addon3">Addr.</label>'+
								'<input type="text" class="form-control" placeholder="Enter Address" id="location" value="'+ marker.options.stAdd +'" onchange="setNewMarkerStats()"/>'+
								'<input style="display: none;" type="text" id="markerId" value="'+ markerEdit.getLayerId(marker) +'" aria-hidden="true"/>'+
								'<span class="input-group-btn">'+
									'<button class="btn btn-secondary" onclick="addressLookup(); return false;" style="padding: 5px 10px 5px 10px; "><span class="oi oi-map-marker oi-size-lg" style="padding-top: 2px; font-size: 20px; color: #ffffff;" aria-hidden="true"></span></button>'+
								'</span>'+
							'</div>'+
						'</div>'+
					'</form>'+
					'<div class="form-group" style="margin-bottom:8px">'+
						'<div class="input-group">'+
							'<label class="input-group-addon" id="basic-addon3">Type</label>'+
							'<select class="form-control" id="type" onchange="setNewMarkerStats()">'+
								'<optgroup label="Supplier">'+
									'<option value=1>Supplier</option>'+
									'<option value=9>Audio & Music</option>'+
									'<option value=10>Animation & Video</option>'+
									'<option value=11>Brand & Marketing</option>'+
									'<option value=12>Localization & Writing</option>'+
									'<option value=13>QA & Testing</option>'+
									'<option value=14>VFX & Lighting</option>'+
									'<option value=15>UI & Player Experience</option>'+
									'<option value=16>Game & Level Design</option>'+
									'<option value=17>Concept & Illustration</option>'+
									'<option value=18>Environment & Character</option>'+
									'<option value=19>Full Service & Co-Developmeny</option>'+
								'<optgroup label="Developer">'+
									'<option value=2>Developer</option>'+
									'<option value=5>Virtual Reality</option>'+
									'<option value=6>Mobile</option>'+
									'<option value=7>Online</option>'+
									'<option value=8>Developer and Publisher</option>'+
								'<optgroup label="Publisher">'+
									'<option value=4>Publisher</option>'+
									'<option value=3>Organization</option>'+
							'</select>'+
						'</div>'+
						'<input style="display: none;" type="text" id="lat" value="'+marker.options.stLat+'" aria-hidden="true"/>'+
						'<input style="display: none;" type="text" id="lng" value="'+marker.options.stLng+'" aria-hidden="true"/>'+
					'</div>'+
					'<div class="modal-footer" style="padding: 0px; border: 0px;">'+
						'<button type="button" class="btn btn-danger" data-toggle="modal" data-target="#deleteCompanyModal">Delete</button>'+
						'<button type="button" class="btn" onclick="cancelEdit()">Cancel</button>'+
						'<button type="button" class="btn btn-primary" onclick="updateCompany()">Update</button>'+
					'</div>'+
				'</form>';
			marker.bindPopup(editForm,{autoClose: false, closeOnClick: false, closeButton: false, autoPanPadding: 5, keepInView: false, minWidth: 300, maxWidth: 800});
			marker.on('click', function(){ marker.openPopup(); });
			marker.openPopup();
			map.panTo(new L.LatLng(marker.options.stLat,marker.options.stLng));
			initEdit(marker);
			document.getElementById('type').value = marker.options.stType;
		}

		//Name Validation
		function validName(str) {
			if (str.length == 0) {
				alert("Please enter a Name");
				return false;
			} else {
				return true;
			}
		}

		//URL Validation
		function validURL(testUrl) {
			var pattern = new RegExp('^(?:(?:(?:https?|ftp):)?\/\/)(?:\S+(?::\S*)?@)?(?:(?!(?:10|127)(?:\.\d{1,3}){3})(?!(?:169\.254|192\.168)(?:\.\d{1,3}){2})(?!172\.(?:1[6-9]|2\d|3[0-1])(?:\.\d{1,3}){2})(?:[1-9]\d?|1\d\d|2[01]\d|22[0-3])(?:\.(?:1?\d{1,2}|2[0-4]\d|25[0-5])){2}(?:\.(?:[1-9]\d?|1\d\d|2[0-4]\d|25[0-4]))|(?:(?:[a-z\u00a1-\uffff0-9]-*)*[a-z\u00a1-\uffff0-9]+)(?:\.(?:[a-z\u00a1-\uffff0-9]-*)*[a-z\u00a1-\uffff0-9]+)*(?:\.(?:[a-z\u00a1-\uffff]{2,})).?)(?::\d{2,5})?(?:[/?#]\S*)?$'); // fragment locater
			if(!pattern.test(testUrl)) {
				alert("Please enter a valid URL");
				return false;
			} else {
				return true;
			}

//TODO Item:
//Get this code to work instead of the above string validation

			/*
			//Actually validate the website exists
			$.ajax({
				type : "GET",
				url : testUrl,
				//data : params,
				crossDomain: true,
				timeout:3000,
				dataType : "jsonp",
				jsonp : "jsonp",
				success : function (response, textS, xhr) {
					alert("ok");
					return true;
				},
				error : function (xmlHttpRequest, textStatus, errorThrown) {
					alert("not ok " + errorThrown);
					 if(textStatus==='timeout')
					  alert("request timed out");
					return false;
				}
			});
			*/

		}

		//Insert Company
		function insertCompany() {
			var name = $("#name").val();
			var website = $("#website").val();
			var address = $("#location").val();
			var type = $("#type").val();
			var lat = $("#lat").val();
			var lng = $("#lng").val();
			if (!validName(name)) { return false;}
			if (!validURL(website)) { return false;}
			$("#loading-mask").show();
			$("#loading").show();
			var dataString = 'name='+ name + '&website=' + website + '&type=' + type + '&address=' + address + '&lat=' + lat + '&lng=' + lng;
			$.ajax({
			  type: "POST",
			  url: "company_add.php",
			  data: dataString,
			  success: function() {
				cancelRegistration();
				$("#loading-mask").hide();
				$("#loading").hide();
				$('#insertSuccessModal').modal('show');
			  }
			});
			return false;
		}

 		//Update Company
		function updateCompany() {
			var id = $("#companyId").val();
			var name = $("#name").val();
			var website = $("#website").val();
			var address = $("#location").val();
			var type = $("#type").val();
			var lat = $("#lat").val();
			var lng = $("#lng").val();
			if (!validName(name)) { return false;}
			if (!validURL(website)) { return false;}
			$("#loading-mask").show();
			$("#loading").show();
			var dataString = 'id='+ id + '&name='+ name + '&website=' + website + '&type=' + type + '&address=' + address + '&lat=' + lat + '&lng=' + lng;
			$.ajax({
			  type: "POST",
			  url: "company_edit.php",
			  data: dataString,
			  success: function() {
				cancelEdit();
				$("#loading-mask").hide();
				$("#loading").hide();
				$('#insertSuccessModal').modal('show');
			  }
			});
			return false;
		}

 		//Delete Company
		function deleteCompany() {
			$("#loading-mask").show();
			$("#loading").show();
			var id = $("#companyId").val();
			var dataString = 'id='+ id;
			$.ajax({
			  type: "POST",
			  url: "company_remove.php",
			  data: dataString,
			  success: function() {
				cancelEdit();
				$("#loading-mask").hide();
				$("#loading").hide();
				$('#insertSuccessModal').modal('show');
			  }
			});
			return false;
		}


/*************************/
//		Examples
/*************************/


/*
		//Click events example
		function logEvent(ev) {
			console.log(ev.type + ' fired on ' + ev.target, performance.now());
		}

		map.on('click', logEvent);
		markers.on('click', logEvent);
*/


/*
		//Move map to click example
		map.on("click", function(e) {
			map.originalEvent.preventDefault();
		    map.setView(e.latlng, map.getZoom());
	    });
*/

	</script>

	</body>
</html>